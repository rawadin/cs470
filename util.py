import numpy as np
import gym
from gym import register
from env import GridEnv
import matplotlib.pyplot as plt
import matplotlib.cm as cm
from matplotlib.colors import LinearSegmentedColormap
from PIL import Image as Image


def plot_trajs(env, trajectories, visited, fig_name, alpha=0.1):
    """Plot the input trajectories"""
    n = env.grid_map_shape[0]
    m = env.grid_map_shape[1]

    obstacles = np.zeros([n, m])
    for obstacle in env.obstacles:
        posx = obstacle // m
        posy = obstacle % m
        obstacles[posx, posy] = 1

    semi_obstacles = np.zeros([n, m])
    for semi_obstacle in env.semi_obstacles:
        posx = semi_obstacle // m
        posy = semi_obstacle % m
        semi_obstacles[posx, posy] = 1

    view = np.zeros([n, m])
    for i in range(n * m):
        if visited[i]:
            x = i // m
            y = i % m
            view[x, y] = 1

    plt.figure()
    plt.imshow(
        semi_obstacles,
        cmap=LinearSegmentedColormap.from_list(
            "semi_obstacles", [(1.0, 1.0, 1.0, 0.0), (0.0, 0.0, 0.0, 0.3)]
        ),
    )
    plt.imshow(
        view,
        cmap=LinearSegmentedColormap.from_list(
            "view", [(0.0, 0.0, 0.0, 0.0), (1.0, 1.0, 0.0, 0.3)]
        ),
    )
    plt.imshow(
        obstacles,
        cmap=LinearSegmentedColormap.from_list(
            "obstacles", [(1.0, 1.0, 1.0, 0.0), (0.0, 0.0, 0.0, 1.0)]
        ),
    )

    for trajectory in trajectories:
        traj_2d = np.array([env.serial_to_twod(s) for s in trajectory])
        y = traj_2d[:, 0]
        x = traj_2d[:, 1]
        plt.plot(x, y, alpha=alpha, color="r")
    plt.savefig(fig_name)
    plt.close()


def register_env():
    if "Gridworld-v1" in gym.envs.registration.registry.env_specs:
        del gym.envs.registration.registry.env_specs["Gridworld-v1"]
    register(
        id="Gridworld-v1",
        entry_point=GridEnv,
        max_episode_steps=200,
        reward_threshold=3 * 50 * 50 * 50 * 50 // 2,
        kwargs={
            "epsilon": 0.9,
            "size": (50, 50),
            "start": 0,
            "obstacle": {
                5,
                6,
                7,
                8,
                9,
                10,
                11,
                12,
                13,
                14,
                55,
                56,
                57,
                58,
                59,
                60,
                61,
                62,
                63,
                64,
                105,
                106,
                107,
                108,
                109,
                110,
                111,
                112,
                113,
                114,
                155,
                156,
                157,
                158,
                159,
                160,
                161,
                162,
                163,
                164,
                21,
                71,
                121,
                171,
                221,
                271,
                321,
                371,
                28,
                78,
                128,
                178,
                228,
                278,
                328,
                378,
                36,
                86,
                136,
                186,
                236,
                286,
                336,
                386,
                393,
                394,
                295,
                345,
                246,
                247,
                98,
                148,
                198,
                49,
                500,
                501,
                502,
                503,
                504,
                850,
                851,
                852,
                853,
                854,
                943,
                944,
                945,
                946,
                947,
                948,
                949,
                1025,
                1026,
                1027,
                1028,
                1029,
                1030,
                1031,
                1032,
                1033,
                1034,
                1035,
                1037,
                1038,
                1039,
                1036,
                1075,
                1076,
                1077,
                1078,
                1079,
                1080,
                1081,
                1082,
                1083,
                1084,
                1085,
                1086,
                1087,
                1088,
                1089,
                1343,
                1344,
                1345,
                1346,
                1347,
                1348,
                1349,
                1550,
                1551,
                1552,
                1553,
                1554,
                1693,
                1694,
                1695,
                1696,
                1697,
                1698,
                1699,
                2105,
                2155,
                2205,
                2255,
                2305,
                2355,
                2405,
                2455,
                2113,
                2163,
                2213,
                2263,
                2313,
                2363,
                2413,
                2463,
                2120,
                2170,
                2220,
                2270,
                2320,
                2370,
                2420,
                2470,
                2128,
                2178,
                2228,
                2278,
                2328,
                2378,
                2428,
                2478,
            },
            "semi_obstacle": {
                210,
                211,
                212,
                213,
                214,
                260,
                261,
                262,
                263,
                264,
                310,
                311,
                312,
                313,
                314,
                360,
                361,
                362,
                363,
                364,
                410,
                411,
                412,
                413,
                414,
                22,
                23,
                24,
                25,
                26,
                27,
                72,
                73,
                74,
                75,
                76,
                77,
                122,
                123,
                124,
                125,
                126,
                127,
                172,
                173,
                174,
                175,
                176,
                177,
                222,
                223,
                224,
                225,
                226,
                227,
                272,
                273,
                274,
                275,
                276,
                277,
                322,
                323,
                324,
                325,
                326,
                327,
                372,
                373,
                374,
                375,
                376,
                377,
                29,
                30,
                31,
                32,
                33,
                34,
                35,
                79,
                80,
                81,
                82,
                83,
                84,
                85,
                129,
                130,
                131,
                132,
                133,
                134,
                135,
                179,
                180,
                181,
                182,
                183,
                184,
                185,
                229,
                230,
                231,
                232,
                233,
                234,
                235,
                279,
                280,
                281,
                282,
                283,
                284,
                285,
                329,
                330,
                331,
                332,
                333,
                334,
                335,
                379,
                380,
                381,
                382,
                383,
                384,
                385,
                37,
                38,
                39,
                40,
                41,
                42,
                87,
                88,
                89,
                90,
                91,
                92,
                137,
                138,
                139,
                140,
                141,
                142,
                187,
                188,
                189,
                190,
                191,
                192,
                237,
                238,
                239,
                240,
                241,
                242,
                287,
                288,
                289,
                290,
                291,
                292,
                337,
                338,
                339,
                340,
                341,
                342,
                387,
                388,
                389,
                390,
                391,
                392,
                43,
                44,
                93,
                94,
                143,
                144,
                193,
                194,
                243,
                244,
                245,
                48,
                395,
                396,
                397,
                398,
                399,
                296,
                297,
                298,
                299,
                346,
                347,
                348,
                349,
                99,
                149,
                199,
                249,
                248,
                293,
                294,
                343,
                344,
                45,
                46,
                47,
                95,
                96,
                97,
                145,
                146,
                147,
                195,
                196,
                197,
                550,
                551,
                552,
                553,
                554,
                600,
                601,
                602,
                603,
                604,
                650,
                651,
                652,
                653,
                654,
                700,
                701,
                702,
                703,
                704,
                750,
                751,
                752,
                753,
                754,
                800,
                801,
                802,
                803,
                804,
                660,
                661,
                662,
                663,
                710,
                711,
                712,
                713,
                760,
                761,
                762,
                763,
                810,
                811,
                812,
                813,
                860,
                861,
                862,
                863,
                910,
                911,
                912,
                913,
                960,
                961,
                962,
                963,
                1010,
                1011,
                1012,
                1013,
                665,
                666,
                667,
                668,
                669,
                715,
                716,
                717,
                718,
                719,
                765,
                766,
                767,
                768,
                769,
                815,
                816,
                817,
                818,
                819,
                865,
                866,
                867,
                868,
                869,
                915,
                916,
                917,
                918,
                919,
                965,
                966,
                967,
                968,
                969,
                1015,
                1016,
                1017,
                1018,
                1019,
                676,
                677,
                678,
                679,
                680,
                681,
                726,
                727,
                728,
                729,
                730,
                731,
                776,
                777,
                778,
                779,
                780,
                781,
                826,
                827,
                828,
                829,
                830,
                831,
                876,
                877,
                878,
                879,
                880,
                881,
                683,
                684,
                685,
                686,
                687,
                688,
                689,
                733,
                734,
                735,
                736,
                737,
                738,
                739,
                783,
                784,
                785,
                786,
                787,
                788,
                789,
                833,
                834,
                835,
                836,
                837,
                838,
                839,
                883,
                884,
                885,
                886,
                887,
                888,
                889,
                443,
                444,
                445,
                446,
                447,
                448,
                449,
                493,
                494,
                495,
                496,
                497,
                498,
                499,
                543,
                544,
                545,
                546,
                547,
                548,
                549,
                593,
                594,
                595,
                596,
                597,
                598,
                599,
                643,
                644,
                645,
                646,
                647,
                648,
                649,
                693,
                694,
                695,
                696,
                697,
                698,
                699,
                743,
                744,
                745,
                746,
                747,
                748,
                749,
                793,
                794,
                795,
                796,
                797,
                798,
                799,
                843,
                844,
                845,
                846,
                847,
                848,
                849,
                893,
                894,
                895,
                896,
                897,
                898,
                899,
                900,
                901,
                902,
                903,
                904,
                950,
                951,
                952,
                953,
                954,
                1000,
                1001,
                1002,
                1003,
                1004,
                1050,
                1051,
                1052,
                1053,
                1054,
                1100,
                1101,
                1102,
                1103,
                1104,
                1150,
                1151,
                1152,
                1153,
                1154,
                1200,
                1201,
                1202,
                1203,
                1204,
                1250,
                1251,
                1252,
                1253,
                1254,
                1300,
                1301,
                1302,
                1303,
                1304,
                1350,
                1351,
                1352,
                1353,
                1354,
                1400,
                1401,
                1402,
                1403,
                1404,
                1450,
                1451,
                1452,
                1453,
                1454,
                1500,
                1501,
                1502,
                1503,
                1504,
                1160,
                1161,
                1162,
                1163,
                1210,
                1211,
                1212,
                1213,
                1260,
                1261,
                1262,
                1263,
                1310,
                1311,
                1312,
                1313,
                1360,
                1361,
                1362,
                1363,
                1410,
                1411,
                1412,
                1413,
                1460,
                1461,
                1462,
                1463,
                1510,
                1511,
                1512,
                1513,
                1165,
                1166,
                1167,
                1168,
                1169,
                1215,
                1216,
                1217,
                1218,
                1219,
                1265,
                1266,
                1267,
                1268,
                1269,
                1315,
                1316,
                1317,
                1318,
                1319,
                1365,
                1366,
                1367,
                1368,
                1369,
                1415,
                1416,
                1417,
                1418,
                1419,
                1465,
                1466,
                1467,
                1468,
                1469,
                1515,
                1516,
                1517,
                1518,
                1519,
                1275,
                1276,
                1277,
                1278,
                1279,
                1280,
                1281,
                1325,
                1326,
                1327,
                1328,
                1329,
                1330,
                1331,
                1375,
                1376,
                1377,
                1378,
                1379,
                1380,
                1381,
                1425,
                1426,
                1427,
                1428,
                1429,
                1430,
                1431,
                1475,
                1476,
                1477,
                1478,
                1479,
                1480,
                1481,
                1525,
                1526,
                1527,
                1528,
                1529,
                1530,
                1531,
                1283,
                1284,
                1285,
                1286,
                1287,
                1288,
                1289,
                1333,
                1334,
                1335,
                1336,
                1337,
                1338,
                1339,
                1383,
                1384,
                1385,
                1386,
                1387,
                1388,
                1389,
                1433,
                1434,
                1435,
                1436,
                1437,
                1438,
                1439,
                1483,
                1484,
                1485,
                1486,
                1487,
                1488,
                1489,
                1533,
                1534,
                1535,
                1536,
                1537,
                1538,
                1539,
                993,
                994,
                995,
                996,
                997,
                998,
                999,
                1043,
                1044,
                1045,
                1046,
                1047,
                1048,
                1049,
                1093,
                1094,
                1095,
                1096,
                1097,
                1098,
                1099,
                1143,
                1144,
                1145,
                1146,
                1147,
                1148,
                1149,
                1193,
                1194,
                1195,
                1196,
                1197,
                1198,
                1199,
                1243,
                1244,
                1245,
                1246,
                1247,
                1248,
                1249,
                1293,
                1294,
                1295,
                1296,
                1297,
                1298,
                1299,
                1393,
                1394,
                1395,
                1396,
                1397,
                1398,
                1399,
                1443,
                1444,
                1445,
                1446,
                1447,
                1448,
                1449,
                1493,
                1494,
                1495,
                1496,
                1497,
                1498,
                1499,
                1543,
                1544,
                1545,
                1546,
                1547,
                1548,
                1549,
                1593,
                1594,
                1595,
                1596,
                1597,
                1598,
                1599,
                1643,
                1644,
                1645,
                1646,
                1647,
                1648,
                1649,
                1743,
                1744,
                1745,
                1746,
                1747,
                1748,
                1749,
                1793,
                1794,
                1795,
                1796,
                1797,
                1798,
                1799,
                1843,
                1844,
                1845,
                1846,
                1847,
                1848,
                1849,
                1893,
                1894,
                1895,
                1896,
                1897,
                1898,
                1899,
                1943,
                1944,
                1945,
                1946,
                1947,
                1948,
                1949,
                1993,
                1994,
                1995,
                1996,
                1997,
                1998,
                1999,
                2043,
                2044,
                2045,
                2046,
                2047,
                2048,
                2049,
                1850,
                1851,
                1852,
                1853,
                1854,
                1900,
                1901,
                1902,
                1903,
                1904,
                1950,
                1951,
                1952,
                1953,
                1954,
                2000,
                2001,
                2002,
                2003,
                2004,
                2050,
                2051,
                2052,
                2053,
                2054,
                2100,
                2101,
                2102,
                2103,
                2104,
                2150,
                2151,
                2152,
                2153,
                2154,
                2200,
                2201,
                2202,
                2203,
                2204,
                2250,
                2251,
                2252,
                2253,
                2254,
                2300,
                2301,
                2302,
                2303,
                2304,
                2350,
                2351,
                2352,
                2353,
                2354,
                2400,
                2401,
                2402,
                2403,
                2404,
                2450,
                2451,
                2452,
                2453,
                2454,
                2106,
                2107,
                2108,
                2109,
                2110,
                2111,
                2112,
                2156,
                2157,
                2158,
                2159,
                2160,
                2161,
                2162,
                2206,
                2207,
                2208,
                2209,
                2210,
                2211,
                2212,
                2256,
                2257,
                2258,
                2259,
                2260,
                2261,
                2262,
                2306,
                2307,
                2308,
                2309,
                2310,
                2311,
                2312,
                2356,
                2357,
                2358,
                2359,
                2360,
                2361,
                2362,
                2406,
                2407,
                2408,
                2409,
                2410,
                2411,
                2412,
                2456,
                2457,
                2458,
                2459,
                2460,
                2461,
                2462,
                2114,
                2115,
                2116,
                2117,
                2118,
                2119,
                2164,
                2165,
                2166,
                2167,
                2168,
                2169,
                2214,
                2215,
                2216,
                2217,
                2218,
                2219,
                2264,
                2265,
                2266,
                2267,
                2268,
                2269,
                2314,
                2315,
                2316,
                2317,
                2318,
                2319,
                2364,
                2365,
                2366,
                2367,
                2368,
                2369,
                2414,
                2415,
                2416,
                2417,
                2418,
                2419,
                2464,
                2465,
                2466,
                2467,
                2468,
                2469,
                2121,
                2122,
                2123,
                2124,
                2125,
                2126,
                2127,
                2171,
                2172,
                2173,
                2174,
                2175,
                2176,
                2177,
                2221,
                2222,
                2223,
                2224,
                2225,
                2226,
                2227,
                2271,
                2272,
                2273,
                2274,
                2275,
                2276,
                2277,
                2321,
                2322,
                2323,
                2324,
                2325,
                2326,
                2327,
                2371,
                2372,
                2373,
                2374,
                2375,
                2376,
                2377,
                2421,
                2422,
                2423,
                2424,
                2425,
                2426,
                2427,
                2471,
                2472,
                2473,
                2474,
                2475,
                2476,
                2477,
                2129,
                2130,
                2131,
                2132,
                2133,
                2134,
                2179,
                2180,
                2181,
                2182,
                2183,
                2184,
                2229,
                2230,
                2231,
                2232,
                2233,
                2234,
                2279,
                2280,
                2281,
                2282,
                2283,
                2284,
                2329,
                2330,
                2331,
                2332,
                2333,
                2334,
                2379,
                2380,
                2381,
                2382,
                2383,
                2384,
                2429,
                2430,
                2431,
                2432,
                2433,
                2434,
                2479,
                2480,
                2481,
                2482,
                2483,
                2484,
                2238,
                2239,
                2240,
                2241,
                2242,
                2243,
                2288,
                2289,
                2290,
                2291,
                2292,
                2293,
                2338,
                2339,
                2340,
                2341,
                2342,
                2343,
                2388,
                2389,
                2390,
                2391,
                2392,
                2393,
                2438,
                2439,
                2440,
                2441,
                2442,
                2443,
                2488,
                2489,
                2490,
                2491,
                2492,
                2493,
            },
        },
    )
